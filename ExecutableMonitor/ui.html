<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malware Monitor Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b1320;
            --card: #111a2b;
            --muted: #9fb0ca;
            --text: #e6eefc;
            --primary: #3b82f6;
            --primary-600: #2563eb;
            --accent: #22d3ee;
            --danger-bg: #401a1c;
            --danger: #fca5a5;
            --success-bg: #163a2a;
            --success: #86efac;
            --warn-bg: #3b2a12;
            --warn: #fde68a;
            --border: #1e2a3f;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            background: radial-gradient(1200px 600px at 100% -20%, rgba(34,211,238,0.08), transparent),
                        radial-gradient(1000px 500px at -10% 110%, rgba(59,130,246,0.12), transparent),
                        var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
        }
        .app {
            display: grid;
            grid-template-rows: auto 1fr;
            min-height: 100vh;
        }
        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background: rgba(11,19,32,0.85);
            backdrop-filter: blur(6px);
            z-index: 10;
        }
        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .brand .logo {
            width: 36px;
            height: 36px;
            display: grid;
            place-items: center;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            box-shadow: 0 6px 24px rgba(59,130,246,0.35);
            font-weight: 700;
        }
        .brand .title {
            display: flex;
            flex-direction: column;
        }
        .brand .title h1 {
            margin: 0;
            font-size: 1.1rem;
            letter-spacing: 0.2px;
        }
        .brand .title span {
            color: var(--muted);
            font-size: 0.8rem;
        }
        .header-right { display: flex; align-items: center; gap: 0.75rem; }
        .status-chip {
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 0.4rem 0.65rem;
            border-radius: 999px;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        .btn {
            border: 1px solid var(--border);
            background: linear-gradient(180deg, #151f33, #0e1726);
            color: var(--text);
            padding: 0.5rem 0.8rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn:hover { border-color: #2b3a57; }

        /* Layout */
        .content {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 1rem;
            padding: 1rem 1.25rem 2rem 1.25rem;
        }
        @media (max-width: 960px) {
            .content { grid-template-columns: 1fr; }
        }

        /* Cards */
        .card {
            background: linear-gradient(180deg, rgba(17,26,43,0.92), rgba(14,23,38,0.92));
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.25);
        }
        .card h3 { margin: 0 0 0.75rem 0; font-size: 1rem; color: var(--text); }
        .subtle { color: var(--muted); font-size: 0.9rem; }

        /* Sidebar: Files */
        .files-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .file-search { display: flex; gap: 0.5rem; }
        .input {
            width: 100%;
            background: #0d1626;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.55rem 0.7rem;
            border-radius: 10px;
            outline: none;
        }
        .list {
            list-style: none;
            margin: 0;
            padding: 0;
            max-height: 66vh;
            overflow: auto;
        }
        .list-item {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 0.5rem;
            padding: 0.7rem 0.6rem;
            border-radius: 10px;
            border: 1px solid transparent;
            cursor: pointer;
        }
        .list-item:hover { background: #0e182a; border-color: var(--border); }
        .list-item.selected { background: #0f1b30; border-color: #2b3a57; }
        .file-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pill { padding: 0.25rem 0.55rem; border-radius: 999px; font-size: 0.75rem; font-weight: 700; text-transform: capitalize; }
        .pill.safe { background: var(--success-bg); color: var(--success); }
        .pill.suspicious { background: var(--danger-bg); color: var(--danger); }
        .pill.analyzing { background: var(--warn-bg); color: var(--warn); }

        /* Main: Analysis */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        @media (max-width: 1200px) { .grid { grid-template-columns: 1fr; } }
        .section { margin-bottom: 1rem; }
        .section h4 { margin: 0 0 0.5rem 0; font-size: 0.95rem; color: var(--muted); }
        .kpi {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 0.75rem;
        }
        .kpi .tile {
            background: #0e1726; border: 1px solid var(--border); border-radius: 12px; padding: 0.8rem;
        }
        .kpi .label { color: var(--muted); font-size: 0.75rem; }
        .kpi .value { font-size: 1.05rem; font-weight: 700; margin-top: 0.25rem; }

        .mono-box { background: #0b1424; border: 1px dashed #24324d; border-radius: 10px; padding: 0.75rem; color: var(--muted); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.82rem; max-height: 220px; overflow: auto; }
        .muted-note { color: var(--muted); font-size: 0.85rem; }
        .split { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        @media (max-width: 720px) { .split { grid-template-columns: 1fr; } }

        .empty { color: var(--muted); text-align: center; padding: 2rem 0; }

        /* AI Assessment Panel */
        .ai-assessment-panel {
            min-height: 300px;
        }
        .assessment-header {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        .assessment-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--muted);
            transition: background-color 0.3s ease;
        }
        .status-indicator.analyzing { background: var(--warn); animation: pulse 2s infinite; }
        .status-indicator.safe { background: var(--success); }
        .status-indicator.suspicious { background: var(--danger); }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .assessment-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .analysis-summary {
            background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(34,211,238,0.05));
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 12px;
            padding: 1rem;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }
        .summary-item {
            text-align: center;
        }
        .summary-label {
            color: var(--muted);
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }
        .summary-value {
            font-weight: 700;
            font-size: 1.1rem;
        }
        .detailed-analysis {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        .analysis-section h4 {
            margin: 0 0 0.75rem 0;
            font-size: 0.95rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .analysis-section h4::before {
            content: '';
            width: 4px;
            height: 16px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 2px;
        }
        .formatted-analysis {
            background: #0b1424;
            border: 1px solid #24324d;
            border-radius: 10px;
            padding: 1rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text);
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Analysis formatting styles */
        .analysis-paragraph {
            margin: 0.5rem 0;
            line-height: 1.6;
        }
        .analysis-h1 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent);
            margin: 1rem 0 0.5rem 0;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 0.25rem;
        }
        .analysis-h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin: 0.8rem 0 0.4rem 0;
        }
        .analysis-h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin: 0.6rem 0 0.3rem 0;
        }
        .analysis-bold {
            font-weight: 700;
            color: var(--accent);
        }
        .analysis-italic {
            font-style: italic;
            color: var(--muted);
        }
        .analysis-inline-code {
            background: rgba(59,130,246,0.2);
            color: var(--accent);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.8rem;
        }
        .analysis-code-block {
            background: #0a0f1a;
            border: 1px solid #24324d;
            border-radius: 6px;
            padding: 0.75rem;
            margin: 0.5rem 0;
            overflow-x: auto;
        }
        .analysis-code-block code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.8rem;
            color: var(--accent);
        }
        .analysis-list {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        .analysis-list-item {
            margin: 0.3rem 0;
            line-height: 1.5;
        }
        .findings-list, .recommendations-list {
            background: #0b1424;
            border: 1px solid #24324d;
            border-radius: 10px;
            padding: 1rem;
        }
        .finding-item, .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(36,50,77,0.5);
        }
        .finding-item:last-child, .recommendation-item:last-child {
            border-bottom: none;
        }
        .finding-icon, .recommendation-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            flex-shrink: 0;
            margin-top: 0.1rem;
        }
        .finding-icon.high { background: var(--danger-bg); color: var(--danger); }
        .finding-icon.medium { background: var(--warn-bg); color: var(--warn); }
        .finding-icon.low { background: var(--success-bg); color: var(--success); }
        .recommendation-icon { background: var(--primary); color: white; }
        .finding-content, .recommendation-content {
            flex: 1;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .finding-title, .recommendation-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text);
        }
        .finding-description, .recommendation-description {
            color: var(--muted);
            font-size: 0.85rem;
        }
    </style>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop stop-color='%233b82f6' offset='0'/><stop stop-color='%2322d3ee' offset='1'/></linearGradient></defs><rect width='100' height='100' rx='22' fill='url(%23g)'/><text x='50' y='58' text-anchor='middle' font-size='48' font-family='Segoe UI' fill='white'>M</text></svg>">
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="brand">
                <div class="logo">M</div>
                <div class="title">
                    <h1>Malware Monitor</h1>
                    <span id="monitoringStatus">Connecting to server...</span>
                </div>
            </div>
        </header>

        <main class="content">
            <!-- Sidebar: Files -->
            <aside class="card">
                <div class="files-head">
                    <h3>Detected Files</h3>
                    <span id="fileCount" class="subtle">0</span>
                </div>
                <div class="file-search">
                    <input id="fileFilter" class="input" placeholder="Filter by name..." />
                </div>
                <p class="subtle" style="margin: 0.6rem 0 0.4rem 0;">Newest items appear at the top.</p>
                <ul id="fileList" class="list"></ul>
            </aside>

            <!-- Main: Analysis -->
            <section class="grid">
                <div class="card">
                    <h3>Analysis</h3>
                    <div id="noFileSelected" class="empty">Select a file from the left to view details.</div>
                    <div id="analysisPanel" class="section" style="display: none;">
                        <div class="section">
                            <h4 id="analysisFileName"></h4>
                            <div class="kpi">
                                <div class="tile"><div class="label">Risk</div><div id="riskLevel" class="value">—</div></div>
                                <div class="tile"><div class="label">Type</div><div id="fileExt" class="value">—</div></div>
                                <div class="tile"><div class="label">Size</div><div id="fileSize" class="value">—</div></div>
                            </div>
                        </div>

                        <div class="split section">
                            <div>
                                <h4>AI Assessment</h4>
                                <div id="geminiAnalysisText" class="mono-box"></div>
                            </div>
                            <div>
                                <h4>Rule-Based Checks</h4>
                                <div id="ruleBasedText" class="mono-box"></div>
                            </div>
                        </div>

                        <div class="section">
                            <h4>File Features</h4>
                            <div class="split">
                                <div class="mono-box">
                                    <div class="muted-note">MIME Type</div>
                                    <div id="fileMime">—</div>
                                    <div class="muted-note" style="margin-top: .6rem;">Magic Type</div>
                                    <div id="fileMagic">—</div>
                                    <div class="muted-note" style="margin-top: .6rem;">Entropy</div>
                                    <div id="fileEntropy">—</div>
                                    <div class="muted-note" style="margin-top: .6rem;">File Header</div>
                                    <div id="fileHeader" style="word-break: break-all; font-size: 0.75rem;">—</div>
                                </div>
                                <div class="mono-box">
                                    <div class="muted-note">SHA256 Hash</div>
                                    <div id="fileHash" style="word-break: break-all;">—</div>
                                    <div class="muted-note" style="margin-top: .6rem;">Executable</div>
                                    <div id="fileExecutable">—</div>
                                    <div class="muted-note" style="margin-top: .6rem;">Digital Signature</div>
                                    <div id="fileSignature">—</div>
                                    <div class="muted-note" style="margin-top: .6rem;">Created</div>
                                    <div id="fileCreated">—</div>
                                </div>
                            </div>
                            <div class="split" style="margin-top: 0.75rem;">
                                <div class="mono-box">
                                    <div class="muted-note">Modified</div>
                                    <div id="fileModified">—</div>
                                    <div class="muted-note" style="margin-top: .6rem;">Strings Count</div>
                                    <div id="stringsCount">—</div>
                                    <div class="muted-note" style="margin-top: .6rem;">Suspicious Count</div>
                                    <div id="suspiciousCount">—</div>
                                </div>
                                <div class="mono-box">
                                    <div class="muted-note">PE Sections</div>
                                    <div id="peSections">—</div>
                                    <div class="muted-note" style="margin-top: .6rem;">PE Timestamp</div>
                                    <div id="peTimestamp">—</div>
                                    <div class="muted-note" style="margin-top: .6rem;">Is DLL</div>
                                    <div id="isDll">—</div>
                                </div>
                            </div>
                        </div>

                        <div id="suspiciousStringsSection" class="section" style="display: none;">
                            <h4>Suspicious Strings</h4>
                            <div id="suspiciousStrings" class="mono-box"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>AI Assessment</h3>
                    <div id="aiAssessmentPanel" class="ai-assessment-panel">
                        <div class="assessment-header">
                            <div class="assessment-status">
                                <span class="status-indicator" id="aiStatusIndicator"></span>
                                <span id="aiStatusText">Select a file to view AI analysis</span>
                            </div>
                        </div>
                        <div class="assessment-content">
                            <div class="analysis-summary" id="analysisSummary" style="display: none;">
                                <div class="summary-grid">
                                    <div class="summary-item">
                                        <div class="summary-label">Risk Assessment</div>
                                        <div class="summary-value" id="riskAssessment">—</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-label">Confidence</div>
                                        <div class="summary-value" id="confidenceLevel">—</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-label">Analysis Time</div>
                                        <div class="summary-value" id="analysisTime">—</div>
                                    </div>
                                </div>
                            </div>
                            <div class="detailed-analysis" id="detailedAnalysis" style="display: none;">
                                <div class="analysis-section">
                                    <h4>Detailed Analysis</h4>
                                    <div id="geminiAnalysisFormatted" class="formatted-analysis"></div>
                                </div>
                                <div class="analysis-section">
                                    <h4>Key Findings</h4>
                                    <div id="keyFindings" class="findings-list"></div>
                                </div>
                                <div class="analysis-section">
                                    <h4>Recommendations</h4>
                                    <div id="recommendations" class="recommendations-list"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Elements
        const monitoringStatus = document.getElementById('monitoringStatus');
        const fileListEl = document.getElementById('fileList');
        const fileCountEl = document.getElementById('fileCount');
        const fileFilterEl = document.getElementById('fileFilter');

        const analysisPanel = document.getElementById('analysisPanel');
        const noFileSelected = document.getElementById('noFileSelected');
        
        // AI Assessment elements
        const aiStatusIndicator = document.getElementById('aiStatusIndicator');
        const aiStatusText = document.getElementById('aiStatusText');
        const analysisSummary = document.getElementById('analysisSummary');
        const detailedAnalysis = document.getElementById('detailedAnalysis');
        const riskAssessment = document.getElementById('riskAssessment');
        const confidenceLevel = document.getElementById('confidenceLevel');
        const analysisTime = document.getElementById('analysisTime');
        const geminiAnalysisFormatted = document.getElementById('geminiAnalysisFormatted');
        const keyFindings = document.getElementById('keyFindings');
        const recommendations = document.getElementById('recommendations');

        // State
        let files = [];
        let pollingInterval;

        // Init
        monitoringStatus.textContent = 'Connecting to server...';
        init();

        function init() {
            attachEvents();
            fetchInitial();
            startPolling();
            refreshStatus();
        }

        function attachEvents() {
            fileFilterEl.addEventListener('input', renderFiles);
        }

        function startPolling() {
            clearInterval(pollingInterval);
            pollingInterval = setInterval(() => {
                fetchFiles();
                refreshStatus();
            }, 2000);
        }

        async function fetchInitial() {
            await fetchFiles();
            renderFiles();
        }

        async function fetchFiles() {
            try {
                const res = await fetch('/api/files');
                const data = await res.json();
                files = mergeFiles(files, data);
                renderFiles();
            } catch (e) {
                monitoringStatus.textContent = 'Connection error. Server may be offline.';
            }
        }

        function mergeFiles(existing, incoming) {
            const map = new Map(existing.map(f => [f.name, f]));
            for (const f of incoming) {
                const prev = map.get(f.name);
                map.set(f.name, prev ? { ...prev, ...f } : f);
            }
            // newest first if details contain time later; fallback to name
            return Array.from(map.values()).sort((a,b) => (b.time || 0) - (a.time || 0));
        }

        async function refreshStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                if (data.monitoring) {
                    monitoringStatus.textContent = `Monitoring: ${data.watched_dir}`;
                } else {
                    monitoringStatus.textContent = 'Monitoring inactive';
                }
            } catch (e) {
                monitoringStatus.textContent = 'Error connecting to server';
            }
        }

        function renderFiles() {
            const filter = fileFilterEl.value.trim().toLowerCase();
            fileListEl.innerHTML = '';
            const items = files.filter(f => !filter || f.name.toLowerCase().includes(filter));
            fileCountEl.textContent = String(items.length);
            for (const file of items) {
                const li = document.createElement('li');
                li.className = 'list-item';
                li.id = `file-${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
                li.innerHTML = `
                    <span class="file-name" title="${file.name}">${file.name}</span>
                    <span class="pill ${file.type}">${file.type === 'analyzing' ? 'analyzing…' : file.type}</span>
                `;
                li.addEventListener('click', () => onSelectFile(file.name));
                fileListEl.appendChild(li);
            }

            // Keep selection highlight accurate
            const selected = document.querySelector('.list-item.selected');
            if (selected) {
                const name = selected.querySelector('.file-name')?.textContent;
                if (name && !items.find(f => f.name === name)) {
                    selected.classList.remove('selected');
                    showEmpty();
                }
            }
        }

        function onSelectFile(name) {
            document.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected'));
            const el = document.getElementById(`file-${name.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (el) el.classList.add('selected');
            const file = files.find(f => f.name === name);
            if (file) fillAnalysis(file);
        }

        function showEmpty() {
            analysisPanel.style.display = 'none';
            noFileSelected.style.display = 'block';
            updateAIAssessment(null);
        }

        function fillAnalysis(file) {
            noFileSelected.style.display = 'none';
            analysisPanel.style.display = 'block';

            // Head
            document.getElementById('analysisFileName').textContent = file.name;

            // Handle analyzing state (no details yet)
            if (!file.details || file.type === 'analyzing') {
                // Show analyzing state
                const riskEl = document.getElementById('riskLevel');
                riskEl.textContent = 'Analyzing...';
                riskEl.style.color = 'var(--warn)';

                // Show analyzing placeholders
                document.getElementById('fileExt').textContent = 'Analyzing...';
                document.getElementById('fileSize').textContent = 'Analyzing...';

                // Clear text blocks
                document.getElementById('geminiAnalysisText').textContent = 'Analysis in progress...';
                document.getElementById('ruleBasedText').textContent = 'Waiting for analysis to complete...';

                // Clear feature blocks
                document.getElementById('fileMime').textContent = '—';
                document.getElementById('fileMagic').textContent = '—';
                document.getElementById('fileEntropy').textContent = '—';
                document.getElementById('fileHash').textContent = '—';
                document.getElementById('fileExecutable').textContent = '—';
                document.getElementById('fileSignature').textContent = '—';
                document.getElementById('fileHeader').textContent = '—';
                document.getElementById('fileCreated').textContent = '—';
                document.getElementById('fileModified').textContent = '—';
                document.getElementById('stringsCount').textContent = '—';
                document.getElementById('suspiciousCount').textContent = '—';
                document.getElementById('peSections').textContent = '—';
                document.getElementById('peTimestamp').textContent = '—';
                document.getElementById('isDll').textContent = '—';

                // Hide suspicious strings
                const stringsSection = document.getElementById('suspiciousStringsSection');
                stringsSection.style.display = 'none';
                return;
            }

            // File has details - show normal analysis
            // KPIs
            const riskEl = document.getElementById('riskLevel');
            riskEl.textContent = file.type === 'suspicious' ? 'High' : (file.type === 'safe' ? 'Low' : 'Unknown');
            riskEl.style.color = file.type === 'suspicious' ? 'var(--danger)' : (file.type === 'safe' ? 'var(--success)' : 'var(--muted)');

            document.getElementById('fileExt').textContent = file.details.ext || '—';
            document.getElementById('fileSize').textContent = file.details.size || '—';

            // Text blocks
            document.getElementById('geminiAnalysisText').textContent = file.details.gemini || '';
            document.getElementById('ruleBasedText').textContent = file.details.rule || '';

            // Feature blocks
            document.getElementById('fileMime').textContent = file.details.mime || '—';
            document.getElementById('fileMagic').textContent = file.details.magic_type || 'Not available';
            document.getElementById('fileEntropy').textContent = file.details.entropy ?? '—';
            document.getElementById('fileHash').textContent = file.details.hash || '—';
            document.getElementById('fileExecutable').textContent = typeof file.details.is_executable === 'boolean' ? (file.details.is_executable ? 'Yes' : 'No') : 'Unknown';
            document.getElementById('fileSignature').textContent = typeof file.details.has_digital_signature === 'boolean' ? (file.details.has_digital_signature ? 'Valid signature' : 'No signature') : 'Not checked';
            document.getElementById('fileHeader').textContent = file.details.file_header || '—';
            document.getElementById('fileCreated').textContent = file.details.created_at || '—';
            document.getElementById('fileModified').textContent = file.details.modified_at || '—';
            document.getElementById('stringsCount').textContent = file.details.strings_count || '—';
            document.getElementById('suspiciousCount').textContent = file.details.suspicious_count || '—';
            document.getElementById('peSections').textContent = file.details.pe_sections || '—';
            document.getElementById('peTimestamp').textContent = file.details.pe_timestamp ? new Date(file.details.pe_timestamp * 1000).toLocaleString() : '—';
            document.getElementById('isDll').textContent = typeof file.details.is_dll === 'boolean' ? (file.details.is_dll ? 'Yes' : 'No') : '—';

            // Suspicious strings
            const stringsSection = document.getElementById('suspiciousStringsSection');
            const stringsBox = document.getElementById('suspiciousStrings');
            if (file.details.suspicious_strings && file.details.suspicious_strings.length) {
                stringsBox.innerHTML = file.details.suspicious_strings.map(s => escapeHtml(s)).join('<br>');
                stringsSection.style.display = 'block';
            } else {
                stringsSection.style.display = 'none';
                stringsBox.textContent = '';
            }

            // Update AI Assessment
            updateAIAssessment(file);
        }

        function updateAIAssessment(file) {
            if (!file) {
                // Reset to default state
                aiStatusIndicator.className = 'status-indicator';
                aiStatusText.textContent = 'Select a file to view AI analysis';
                analysisSummary.style.display = 'none';
                detailedAnalysis.style.display = 'none';
                return;
            }

            // Update status indicator and text
            aiStatusIndicator.className = `status-indicator ${file.type}`;
            
            if (file.type === 'analyzing') {
                aiStatusText.textContent = 'AI analysis in progress...';
                analysisSummary.style.display = 'none';
                detailedAnalysis.style.display = 'none';
            } else {
                aiStatusText.textContent = 'AI analysis complete';
                analysisSummary.style.display = 'block';
                detailedAnalysis.style.display = 'block';
                
                // Update summary
                riskAssessment.textContent = file.type === 'suspicious' ? 'High Risk' : (file.type === 'safe' ? 'Low Risk' : 'Unknown');
                riskAssessment.style.color = file.type === 'suspicious' ? 'var(--danger)' : (file.type === 'safe' ? 'var(--success)' : 'var(--muted)');
                
                // Simulate confidence and analysis time (you can replace with real data)
                confidenceLevel.textContent = file.details.gemini ? '85%' : 'N/A';
                analysisTime.textContent = file.details.analysis_time || '2.3s';
                
                // Format and display AI analysis
                if (file.details.gemini) {
                    geminiAnalysisFormatted.innerHTML = formatAIAnalysis(file.details.gemini);
                } else {
                    geminiAnalysisFormatted.innerHTML = '<p class="analysis-paragraph">No AI analysis available for this file.</p>';
                }
                
                // Generate key findings and recommendations
                generateKeyFindings(file);
                generateRecommendations(file);
            }
        }

        function formatAIAnalysis(analysis) {
            if (!analysis) return 'No analysis available';
            
            // Convert markdown to HTML for better formatting
            let formatted = analysis
                // Convert headers
                .replace(/^### (.*$)/gim, '<h3 class="analysis-h3">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="analysis-h2">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="analysis-h1">$1</h1>')
                // Convert bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong class="analysis-bold">$1</strong>')
                // Convert italic text
                .replace(/\*(.*?)\*/g, '<em class="analysis-italic">$1</em>')
                // Convert code blocks
                .replace(/```([\s\S]*?)```/g, '<pre class="analysis-code-block"><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code class="analysis-inline-code">$1</code>')
                // Convert lists
                .replace(/^\* (.*$)/gim, '<li class="analysis-list-item">$1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li class="analysis-list-item">$1</li>')
                // Convert line breaks
                .replace(/\n\n/g, '</p><p class="analysis-paragraph">')
                .replace(/\n/g, '<br>')
                // Wrap in paragraph tags
                .replace(/^(.*)$/gm, '<p class="analysis-paragraph">$1</p>')
                // Clean up empty paragraphs
                .replace(/<p class="analysis-paragraph"><\/p>/g, '')
                // Clean up list items that are already wrapped in paragraphs
                .replace(/<p class="analysis-paragraph">(<li class="analysis-list-item">.*<\/li>)<\/p>/g, '$1')
                // Wrap consecutive list items in ul/ol
                .replace(/(<li class="analysis-list-item">.*<\/li>)(<br>)?(<li class="analysis-list-item">.*<\/li>)/g, '<ul class="analysis-list">$1$3</ul>')
                .replace(/<ul class="analysis-list">(<li class="analysis-list-item">.*<\/li>)<br>(<li class="analysis-list-item">.*<\/li>)<\/ul>/g, '<ul class="analysis-list">$1$2</ul>');
            
            return formatted;
        }

        function generateKeyFindings(file) {
            const findings = [];
            
            if (file.type === 'suspicious') {
                findings.push({
                    level: 'high',
                    title: 'Suspicious File Detected',
                    description: 'This file has been flagged as potentially malicious based on AI analysis.'
                });
            }
            
            if (file.details.suspicious_strings && file.details.suspicious_strings.length > 0) {
                findings.push({
                    level: 'medium',
                    title: 'Suspicious Strings Found',
                    description: `Found ${file.details.suspicious_strings.length} suspicious string patterns.`
                });
            }
            
            if (file.details.entropy && file.details.entropy > 7.5) {
                findings.push({
                    level: 'medium',
                    title: 'High Entropy Detected',
                    description: `File entropy of ${file.details.entropy} suggests possible encryption or obfuscation.`
                });
            }
            
            if (file.details.is_executable === false && file.details.ext && ['.exe', '.dll', '.bat', '.cmd'].some(ext => file.details.ext.toLowerCase().includes(ext))) {
                findings.push({
                    level: 'low',
                    title: 'File Type Mismatch',
                    description: 'File extension suggests executable but file is not executable.'
                });
            }
            
            if (findings.length === 0) {
                findings.push({
                    level: 'low',
                    title: 'No Significant Findings',
                    description: 'No suspicious patterns or behaviors detected in this file.'
                });
            }
            
            keyFindings.innerHTML = findings.map(finding => `
                <div class="finding-item">
                    <div class="finding-icon ${finding.level}">!</div>
                    <div class="finding-content">
                        <div class="finding-title">${finding.title}</div>
                        <div class="finding-description">${finding.description}</div>
                    </div>
                </div>
            `).join('');
        }

        function generateRecommendations(file) {
            const recommendations_list = [];
            
            if (file.type === 'suspicious') {
                recommendations_list.push({
                    title: 'Quarantine File',
                    description: 'Move this file to a secure quarantine location and avoid executing it.'
                });
                recommendations_list.push({
                    title: 'Run Full System Scan',
                    description: 'Perform a comprehensive antivirus scan to check for related threats.'
                });
            } else if (file.type === 'safe') {
                recommendations_list.push({
                    title: 'File Appears Safe',
                    description: 'No immediate action required. Continue monitoring for any changes.'
                });
            } else {
                recommendations_list.push({
                    title: 'Monitor File',
                    description: 'Keep this file under observation for any suspicious behavior.'
                });
            }
            
            if (file.details.suspicious_strings && file.details.suspicious_strings.length > 0) {
                recommendations_list.push({
                    title: 'Investigate Strings',
                    description: 'Review the suspicious strings to understand their purpose and context.'
                });
            }
            
            recommendations.innerHTML = recommendations_list.map(rec => `
                <div class="recommendation-item">
                    <div class="recommendation-icon">→</div>
                    <div class="recommendation-content">
                        <div class="recommendation-title">${rec.title}</div>
                        <div class="recommendation-description">${rec.description}</div>
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
    </script>
</body>
</html>
